#!/bin/sh

export DOTHOME=$HOME/dotfiles

git submodule update --init

if [ $SPIN ]; then
  mv $HOME/.config $HOME/spinconfig
  ln -s $DOTHOME/config $HOME/.config
  mv $HOME/spinconfig/* -t $HOME/.config/
else
  ln -s $DOTHOME/config $HOME/.config
fi

# Not everybody plays nice with XDG
ln -sf $DOTHOME/config/ctags.d/ $HOME/.ctags.d
ln -sf $DOTHOME/config/dlv $HOME/.dlv

ln -sf $DOTHOME/tcolors $HOME/.tcolors
ln -sf $DOTHOME/terminfo $HOME/.terminfo

ln -sf $DOTHOME/config/tmux/tmux.conf $HOME/.tmux.conf
ln -sf $DOTHOME/config/tmux/tmux-powerlinerc $HOME/.tmux-powerlinerc
ln -sf $DOTHOME/config/ruby/pryrc $HOME/.pryrc

ln -sf $DOTHOME/zsh/zprofile $HOME/.zprofile
ln -sf $DOTHOME/zsh/zshrc $HOME/.zshrc

ln -sf $DOTHOME/config/git/config $HOME/.gitconfig


if [[ $(uname -a | grep "Darwin") ]]; then
  brew bundle
fi

if [ $SPIN ]; then
  [ ! -f "./nvim-linux64.deb" ] && wget https://github.com/neovim/neovim/releases/download/nightly/nvim-linux64.deb

  sudo apt install ./nvim-linux64.deb

  xargs sudo apt-get -y install < packages.txt

  git config core.editor /usr/bin/nvim

  if [ -f "${HOME}/.nix-profile/etc/profile.d/nix.sh" ]; then
    source "${HOME}/.nix-profile/etc/profile.d/nix.sh"
  fi

  ${HOME}/.nix-profile/bin/nix-env -iA nixpkgs.fzf
  ${HOME}/.nix-profile/bin/nix-env -iA nixpkgs.sysz
  ${HOME}/.nix-profile/bin/nix-env -iA nixpkgs.delta
  ${HOME}/.nix-profile/bin/nix-env -iA nixpkgs.exa
fi

tldr -u

nvim --headless -u $DOTHOME/config/nvim/bootstrap.vim -c 'autocmd User PackerComplete quitall' -c 'PackerSync'
nvim --headless -c 'MasonInstall sorbet' -c q
nvim --headless -c 'MasonInstall solargraph' -c q
nvim --headless -c 'MasonInstall typescript-language-server' -c q
nvim --headless -c 'TSInstallSync! typescript' -c q
nvim --headless -c 'TSInstallSync! tsx' -c q
nvim --headless -c 'TSInstallSync! ruby' -c q
